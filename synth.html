<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Synth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2rem;
            font-weight: 300;
            letter-spacing: 4px;
            color: #fff;
            text-transform: uppercase;
        }

        header p {
            color: #666;
            margin-top: 5px;
        }

        .synth-panel {
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow:
                0 10px 40px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .controls-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-section {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .control-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #888;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .knob-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .knob {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3a3a5a 0%, #2a2a4a 100%);
            box-shadow:
                0 4px 10px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
            position: relative;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .knob:hover {
            box-shadow:
                0 4px 15px rgba(100,150,255,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .knob::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 20px;
            background: linear-gradient(to bottom, #fff, #aaa);
            border-radius: 2px;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            transform-origin: bottom center;
        }

        .knob-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .knob-value {
            font-size: 0.75rem;
            color: #fff;
            font-family: monospace;
        }

        .waveform-select {
            display: flex;
            gap: 8px;
        }

        .wave-btn {
            width: 40px;
            height: 35px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .wave-btn:hover {
            border-color: rgba(100,150,255,0.5);
        }

        .wave-btn.active {
            background: rgba(100,150,255,0.3);
            border-color: #7289da;
        }

        .wave-btn svg {
            width: 24px;
            height: 16px;
            stroke: #888;
            stroke-width: 2;
            fill: none;
        }

        .wave-btn.active svg {
            stroke: #fff;
        }

        /* ADSR Visualization */
        .adsr-visual {
            height: 80px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .adsr-canvas {
            width: 100%;
            height: 100%;
        }

        /* Keyboard */
        .keyboard-container {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
        }

        .keyboard {
            display: flex;
            justify-content: center;
            position: relative;
            height: 150px;
            margin: 0 auto;
            max-width: 700px;
        }

        .key {
            position: relative;
            cursor: pointer;
            transition: transform 0.05s, box-shadow 0.05s;
        }

        .key.white {
            width: 50px;
            height: 150px;
            background: linear-gradient(180deg, #fff 0%, #e8e8e8 100%);
            border: 1px solid #999;
            border-radius: 0 0 6px 6px;
            z-index: 1;
            margin: 0 1px;
        }

        .key.white:hover {
            background: linear-gradient(180deg, #fff 0%, #ddd 100%);
        }

        .key.white.active {
            background: linear-gradient(180deg, #ddd 0%, #ccc 100%);
            transform: translateY(2px);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .key.black {
            width: 30px;
            height: 95px;
            background: linear-gradient(180deg, #333 0%, #111 100%);
            border-radius: 0 0 4px 4px;
            position: absolute;
            z-index: 2;
            top: 0;
        }

        .key.black:hover {
            background: linear-gradient(180deg, #444 0%, #222 100%);
        }

        .key.black.active {
            background: linear-gradient(180deg, #222 0%, #000 100%);
            height: 93px;
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #999;
            pointer-events: none;
        }

        .key.black .key-label {
            color: #666;
            bottom: 8px;
        }

        /* Sequencer */
        .sequencer-container {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
        }

        .sequencer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sequencer-header h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #888;
            font-weight: 500;
        }

        .sequencer-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .seq-btn {
            background: rgba(100,150,255,0.2);
            border: 1px solid rgba(100,150,255,0.3);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .seq-btn:hover {
            background: rgba(100,150,255,0.3);
        }

        .seq-btn.playing {
            background: rgba(100,255,150,0.3);
            border-color: rgba(100,255,150,0.5);
        }

        .tempo-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #888;
            font-size: 0.8rem;
        }

        .tempo-control input {
            width: 60px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            padding: 6px;
            border-radius: 4px;
            text-align: center;
        }

        .sequencer-grid {
            display: grid;
            grid-template-columns: 80px repeat(16, 1fr);
            gap: 4px;
        }

        .seq-row {
            display: contents;
        }

        .seq-note-label {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 0.75rem;
            color: #888;
            font-family: monospace;
        }

        .seq-step {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s;
            border: 1px solid transparent;
        }

        .seq-step:hover {
            background: rgba(255,255,255,0.1);
        }

        .seq-step.active {
            background: linear-gradient(135deg, #7289da 0%, #5b6eae 100%);
            box-shadow: 0 0 10px rgba(100,150,255,0.5);
        }

        .seq-step.current {
            border-color: #fff;
        }

        .seq-step:nth-child(4n+2) {
            background: rgba(255,255,255,0.08);
        }

        .seq-step.active:nth-child(4n+2) {
            background: linear-gradient(135deg, #7289da 0%, #5b6eae 100%);
        }

        /* Visualizer */
        .visualizer {
            height: 100px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin-top: 25px;
            overflow: hidden;
        }

        .visualizer canvas {
            width: 100%;
            height: 100%;
        }

        /* Note Display */
        .note-display-container {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
        }

        .note-display-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .note-display-header h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #888;
            font-weight: 500;
        }

        .keyboard-mode-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .keyboard-mode-toggle span {
            font-size: 0.75rem;
            color: #888;
        }

        .mode-switch {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .mode-btn {
            padding: 6px 12px;
            font-size: 0.7rem;
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #7289da;
            color: #fff;
        }

        .mode-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .note-display {
            min-height: 80px;
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            padding: 15px;
        }

        .note-display .note {
            font-size: 2.5rem;
            font-weight: 300;
            color: #7289da;
            text-shadow: 0 0 20px rgba(114, 137, 218, 0.5);
            animation: noteAppear 0.1s ease-out;
        }

        .note-display .note.sharp {
            color: #9b59b6;
            text-shadow: 0 0 20px rgba(155, 89, 182, 0.5);
        }

        .note-display .empty {
            font-size: 1rem;
            color: #444;
        }

        @keyframes noteAppear {
            from {
                transform: scale(1.2);
                opacity: 0.5;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .key-hint {
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }

        /* Presets */
        .presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .preset-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #888;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .preset-btn.active {
            background: rgba(100,150,255,0.2);
            border-color: #7289da;
            color: #fff;
        }

        /* Effects */
        .effect-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .toggle {
            width: 40px;
            height: 22px;
            background: rgba(0,0,0,0.3);
            border-radius: 11px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
        }

        .toggle.active {
            background: rgba(100,150,255,0.5);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle.active::after {
            transform: translateX(18px);
        }

        .toggle-label {
            font-size: 0.75rem;
            color: #888;
        }

        /* Start prompt */
        .start-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: pointer;
        }

        .start-prompt-content {
            text-align: center;
        }

        .start-prompt h2 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .start-prompt p {
            color: #666;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="start-prompt" id="startPrompt">
        <div class="start-prompt-content">
            <h2>Click to Start</h2>
            <p>Web Audio requires user interaction to begin</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Web Synth</h1>
            <p>Play with your computer keyboard - switch between Standard and Extended modes</p>
        </header>

        <div class="synth-panel">
            <div class="controls-row">
                <!-- Oscillator 1 -->
                <div class="control-section">
                    <h3>Oscillator 1</h3>
                    <div class="waveform-select" id="osc1Wave">
                        <button class="wave-btn active" data-wave="sine" title="Sine">
                            <svg viewBox="0 0 24 16"><path d="M0,8 Q6,0 12,8 T24,8"/></svg>
                        </button>
                        <button class="wave-btn" data-wave="square" title="Square">
                            <svg viewBox="0 0 24 16"><path d="M0,12 L0,4 L6,4 L6,12 L12,12 L12,4 L18,4 L18,12 L24,12"/></svg>
                        </button>
                        <button class="wave-btn" data-wave="sawtooth" title="Sawtooth">
                            <svg viewBox="0 0 24 16"><path d="M0,12 L8,4 L8,12 L16,4 L16,12 L24,4"/></svg>
                        </button>
                        <button class="wave-btn" data-wave="triangle" title="Triangle">
                            <svg viewBox="0 0 24 16"><path d="M0,12 L6,4 L12,12 L18,4 L24,12"/></svg>
                        </button>
                    </div>
                    <div class="knob-row" style="margin-top: 15px;">
                        <div class="knob-container">
                            <div class="knob" data-param="osc1Gain" data-min="0" data-max="1" data-value="0.5"></div>
                            <span class="knob-label">Level</span>
                            <span class="knob-value" id="osc1GainVal">0.50</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="osc1Detune" data-min="-100" data-max="100" data-value="0"></div>
                            <span class="knob-label">Detune</span>
                            <span class="knob-value" id="osc1DetuneVal">0</span>
                        </div>
                    </div>
                </div>

                <!-- Oscillator 2 -->
                <div class="control-section">
                    <h3>Oscillator 2</h3>
                    <div class="waveform-select" id="osc2Wave">
                        <button class="wave-btn" data-wave="sine" title="Sine">
                            <svg viewBox="0 0 24 16"><path d="M0,8 Q6,0 12,8 T24,8"/></svg>
                        </button>
                        <button class="wave-btn active" data-wave="square" title="Square">
                            <svg viewBox="0 0 24 16"><path d="M0,12 L0,4 L6,4 L6,12 L12,12 L12,4 L18,4 L18,12 L24,12"/></svg>
                        </button>
                        <button class="wave-btn" data-wave="sawtooth" title="Sawtooth">
                            <svg viewBox="0 0 24 16"><path d="M0,12 L8,4 L8,12 L16,4 L16,12 L24,4"/></svg>
                        </button>
                        <button class="wave-btn" data-wave="triangle" title="Triangle">
                            <svg viewBox="0 0 24 16"><path d="M0,12 L6,4 L12,12 L18,4 L24,12"/></svg>
                        </button>
                    </div>
                    <div class="knob-row" style="margin-top: 15px;">
                        <div class="knob-container">
                            <div class="knob" data-param="osc2Gain" data-min="0" data-max="1" data-value="0.3"></div>
                            <span class="knob-label">Level</span>
                            <span class="knob-value" id="osc2GainVal">0.30</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="osc2Detune" data-min="-100" data-max="100" data-value="5"></div>
                            <span class="knob-label">Detune</span>
                            <span class="knob-value" id="osc2DetuneVal">5</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="osc2Octave" data-min="-2" data-max="2" data-value="0"></div>
                            <span class="knob-label">Octave</span>
                            <span class="knob-value" id="osc2OctaveVal">0</span>
                        </div>
                    </div>
                </div>

                <!-- Filter -->
                <div class="control-section">
                    <h3>Filter</h3>
                    <div class="knob-row">
                        <div class="knob-container">
                            <div class="knob" data-param="filterCutoff" data-min="20" data-max="20000" data-value="5000" data-log="true"></div>
                            <span class="knob-label">Cutoff</span>
                            <span class="knob-value" id="filterCutoffVal">5000</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="filterRes" data-min="0" data-max="20" data-value="1"></div>
                            <span class="knob-label">Resonance</span>
                            <span class="knob-value" id="filterResVal">1.0</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="filterEnv" data-min="0" data-max="5000" data-value="2000"></div>
                            <span class="knob-label">Env Amt</span>
                            <span class="knob-value" id="filterEnvVal">2000</span>
                        </div>
                    </div>
                </div>

                <!-- ADSR -->
                <div class="control-section">
                    <h3>Envelope</h3>
                    <div class="adsr-visual">
                        <canvas class="adsr-canvas" id="adsrCanvas"></canvas>
                    </div>
                    <div class="knob-row">
                        <div class="knob-container">
                            <div class="knob" data-param="attack" data-min="0.001" data-max="2" data-value="0.01"></div>
                            <span class="knob-label">Attack</span>
                            <span class="knob-value" id="attackVal">0.01</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="decay" data-min="0.001" data-max="2" data-value="0.2"></div>
                            <span class="knob-label">Decay</span>
                            <span class="knob-value" id="decayVal">0.20</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="sustain" data-min="0" data-max="1" data-value="0.5"></div>
                            <span class="knob-label">Sustain</span>
                            <span class="knob-value" id="sustainVal">0.50</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="release" data-min="0.001" data-max="3" data-value="0.3"></div>
                            <span class="knob-label">Release</span>
                            <span class="knob-value" id="releaseVal">0.30</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-row">
                <!-- Effects -->
                <div class="control-section">
                    <h3>Effects</h3>
                    <div class="effect-toggle">
                        <div class="toggle" id="delayToggle"></div>
                        <span class="toggle-label">Delay</span>
                    </div>
                    <div class="knob-row">
                        <div class="knob-container">
                            <div class="knob" data-param="delayTime" data-min="0.05" data-max="1" data-value="0.3"></div>
                            <span class="knob-label">Time</span>
                            <span class="knob-value" id="delayTimeVal">0.30</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="delayFeedback" data-min="0" data-max="0.9" data-value="0.4"></div>
                            <span class="knob-label">Feedback</span>
                            <span class="knob-value" id="delayFeedbackVal">0.40</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" data-param="delayMix" data-min="0" data-max="1" data-value="0.3"></div>
                            <span class="knob-label">Mix</span>
                            <span class="knob-value" id="delayMixVal">0.30</span>
                        </div>
                    </div>
                </div>

                <!-- Master -->
                <div class="control-section">
                    <h3>Master</h3>
                    <div class="knob-row">
                        <div class="knob-container">
                            <div class="knob" data-param="masterGain" data-min="0" data-max="1" data-value="0.7"></div>
                            <span class="knob-label">Volume</span>
                            <span class="knob-value" id="masterGainVal">0.70</span>
                        </div>
                    </div>
                    <h3 style="margin-top: 15px;">Presets</h3>
                    <div class="presets">
                        <button class="preset-btn" data-preset="init">Init</button>
                        <button class="preset-btn" data-preset="bass">Bass</button>
                        <button class="preset-btn" data-preset="lead">Lead</button>
                        <button class="preset-btn" data-preset="pad">Pad</button>
                        <button class="preset-btn" data-preset="pluck">Pluck</button>
                        <button class="preset-btn" data-preset="brass">Brass</button>
                    </div>
                </div>
            </div>

            <!-- Visualizer -->
            <div class="visualizer">
                <canvas id="visualizer"></canvas>
            </div>

            <!-- Note Display -->
            <div class="note-display-container">
                <div class="note-display-header">
                    <h3>Now Playing</h3>
                    <div class="keyboard-mode-toggle">
                        <span>Keyboard Mode:</span>
                        <div class="mode-switch">
                            <button class="mode-btn active" data-mode="standard" onclick="setKeyboardMode('standard')">Standard</button>
                            <button class="mode-btn" data-mode="extended" onclick="setKeyboardMode('extended')">Extended (Q-/)</button>
                        </div>
                    </div>
                </div>
                <div class="note-display" id="noteDisplay">
                    <span class="empty">Play a note...</span>
                </div>
                <div class="key-hint" id="keyHint">
                    Standard: A-K white keys, W-U black keys (C4-C5)
                </div>
            </div>

            <!-- Keyboard -->
            <div class="keyboard-container">
                <div class="keyboard" id="keyboard"></div>
            </div>

            <!-- Sequencer -->
            <div class="sequencer-container">
                <div class="sequencer-header">
                    <h3>Step Sequencer</h3>
                    <div class="sequencer-controls">
                        <div class="tempo-control">
                            <span>BPM</span>
                            <input type="number" id="tempo" value="120" min="40" max="240">
                        </div>
                        <button class="seq-btn" id="seqPlayBtn">Play</button>
                        <button class="seq-btn" id="seqClearBtn">Clear</button>
                    </div>
                </div>
                <div class="sequencer-grid" id="sequencerGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // Audio context
        let audioCtx = null;
        let masterGain = null;
        let analyser = null;
        let delayNode = null;
        let delayFeedback = null;
        let delayMix = null;
        let filter = null;

        // Synth state
        const state = {
            osc1Wave: 'sine',
            osc2Wave: 'square',
            osc1Gain: 0.5,
            osc2Gain: 0.3,
            osc1Detune: 0,
            osc2Detune: 5,
            osc2Octave: 0,
            filterCutoff: 5000,
            filterRes: 1,
            filterEnv: 2000,
            attack: 0.01,
            decay: 0.2,
            sustain: 0.5,
            release: 0.3,
            delayTime: 0.3,
            delayFeedback: 0.4,
            delayMix: 0.3,
            delayEnabled: false,
            masterGain: 0.7
        };

        // Active voices
        const activeVoices = new Map();

        // Keyboard mode
        let keyboardMode = 'standard';

        // Note frequencies (expanded for more octaves)
        const noteFreqs = {
            'C2': 65.41, 'C#2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'E2': 82.41,
            'F2': 87.31, 'F#2': 92.50, 'G2': 98.00, 'G#2': 103.83, 'A2': 110.00,
            'A#2': 116.54, 'B2': 123.47,
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81,
            'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00,
            'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63,
            'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00,
            'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25,
            'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00,
            'A#5': 932.33, 'B5': 987.77,
            'C6': 1046.50
        };

        // Standard keyboard mapping (piano-style, one octave)
        const standardKeyMap = {
            'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4',
            'f': 'F4', 't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4',
            'u': 'A#4', 'j': 'B4', 'k': 'C5'
        };

        // Extended keyboard mapping (Q to /, chromatic over ~2.5 octaves)
        const extendedKeyMap = {
            // Top row: C3 to B3
            'q': 'C3', '2': 'C#3', 'w': 'D3', '3': 'D#3', 'e': 'E3',
            'r': 'F3', '5': 'F#3', 't': 'G3', '6': 'G#3', 'y': 'A3',
            '7': 'A#3', 'u': 'B3',
            // Middle row: C4 to B4
            'i': 'C4', '9': 'C#4', 'o': 'D4', '0': 'D#4', 'p': 'E4',
            '[': 'F4', '=': 'F#4', ']': 'G4',
            'a': 'G#4', 'z': 'A4', 's': 'A#4', 'x': 'B4',
            // Bottom row: C5 to C6
            'c': 'C5', 'f': 'C#5', 'v': 'D5', 'g': 'D#5', 'b': 'E5',
            'n': 'F5', 'j': 'F#5', 'm': 'G5', 'k': 'G#5', ',': 'A5',
            'l': 'A#5', '.': 'B5', '/': 'C6'
        };

        // Active key map (switches based on mode)
        let keyMap = standardKeyMap;

        // Initialize audio
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Master gain
            masterGain = audioCtx.createGain();
            masterGain.gain.value = state.masterGain;

            // Analyser for visualization
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;

            // Filter
            filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = state.filterCutoff;
            filter.Q.value = state.filterRes;

            // Delay
            delayNode = audioCtx.createDelay(2);
            delayNode.delayTime.value = state.delayTime;

            delayFeedback = audioCtx.createGain();
            delayFeedback.gain.value = state.delayFeedback;

            delayMix = audioCtx.createGain();
            delayMix.gain.value = state.delayEnabled ? state.delayMix : 0;

            const dryGain = audioCtx.createGain();
            dryGain.gain.value = 1;

            // Routing
            filter.connect(dryGain);
            filter.connect(delayNode);
            delayNode.connect(delayFeedback);
            delayFeedback.connect(delayNode);
            delayNode.connect(delayMix);

            dryGain.connect(masterGain);
            delayMix.connect(masterGain);

            masterGain.connect(analyser);
            analyser.connect(audioCtx.destination);

            // Start visualization
            drawVisualizer();
        }

        // Play a note
        function playNote(note) {
            if (!audioCtx || activeVoices.has(note)) return;

            const freq = noteFreqs[note];
            if (!freq) return;

            const now = audioCtx.currentTime;

            // Create oscillators
            const osc1 = audioCtx.createOscillator();
            osc1.type = state.osc1Wave;
            osc1.frequency.value = freq;
            osc1.detune.value = state.osc1Detune;

            const osc2 = audioCtx.createOscillator();
            osc2.type = state.osc2Wave;
            osc2.frequency.value = freq * Math.pow(2, state.osc2Octave);
            osc2.detune.value = state.osc2Detune;

            // Oscillator gains
            const osc1Gain = audioCtx.createGain();
            osc1Gain.gain.value = state.osc1Gain;

            const osc2Gain = audioCtx.createGain();
            osc2Gain.gain.value = state.osc2Gain;

            // Envelope
            const envelope = audioCtx.createGain();
            envelope.gain.setValueAtTime(0, now);
            envelope.gain.linearRampToValueAtTime(1, now + state.attack);
            envelope.gain.linearRampToValueAtTime(state.sustain, now + state.attack + state.decay);

            // Filter envelope
            const filterFreq = state.filterCutoff;
            const filterEnvAmt = state.filterEnv;
            filter.frequency.setValueAtTime(filterFreq, now);
            filter.frequency.linearRampToValueAtTime(filterFreq + filterEnvAmt, now + state.attack);
            filter.frequency.linearRampToValueAtTime(filterFreq + filterEnvAmt * state.sustain, now + state.attack + state.decay);

            // Connect
            osc1.connect(osc1Gain);
            osc2.connect(osc2Gain);
            osc1Gain.connect(envelope);
            osc2Gain.connect(envelope);
            envelope.connect(filter);

            // Start
            osc1.start(now);
            osc2.start(now);

            activeVoices.set(note, { osc1, osc2, envelope, osc1Gain, osc2Gain });

            // Update keyboard UI
            const keyEl = document.querySelector(`.key[data-note="${note}"]`);
            if (keyEl) keyEl.classList.add('active');

            // Update note display
            updateNoteDisplay();
        }

        // Stop a note
        function stopNote(note) {
            const voice = activeVoices.get(note);
            if (!voice) return;

            const now = audioCtx.currentTime;

            voice.envelope.gain.cancelScheduledValues(now);
            voice.envelope.gain.setValueAtTime(voice.envelope.gain.value, now);
            voice.envelope.gain.linearRampToValueAtTime(0, now + state.release);

            // Filter release
            filter.frequency.cancelScheduledValues(now);
            filter.frequency.setValueAtTime(filter.frequency.value, now);
            filter.frequency.linearRampToValueAtTime(state.filterCutoff, now + state.release);

            setTimeout(() => {
                voice.osc1.stop();
                voice.osc2.stop();
            }, state.release * 1000 + 50);

            activeVoices.delete(note);

            // Update keyboard UI
            const keyEl = document.querySelector(`.key[data-note="${note}"]`);
            if (keyEl) keyEl.classList.remove('active');

            // Update note display
            updateNoteDisplay();
        }

        // Update note display
        function updateNoteDisplay() {
            const display = document.getElementById('noteDisplay');
            const notes = Array.from(activeVoices.keys());

            if (notes.length === 0) {
                display.innerHTML = '<span class="empty">Play a note...</span>';
            } else {
                display.innerHTML = notes.map(note => {
                    // Format note for display (e.g., C#4 -> C#4, use ♯ for sharps)
                    const displayNote = note.replace('#', '♯');
                    const isSharp = note.includes('#');
                    return `<span class="note ${isSharp ? 'sharp' : ''}">${displayNote}</span>`;
                }).join('');
            }
        }

        // Set keyboard mode
        function setKeyboardMode(mode) {
            // Stop all current notes
            activeVoices.forEach((_, note) => stopNote(note));

            keyboardMode = mode;
            keyMap = mode === 'extended' ? extendedKeyMap : standardKeyMap;

            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Update hint text
            const hint = document.getElementById('keyHint');
            if (mode === 'extended') {
                hint.innerHTML = `
                    Extended: Q-U (C3-B3), I-] + A,Z,S,X (C4-B4), C-/ (C5-C6)<br>
                    Number keys for sharps/flats
                `;
            } else {
                hint.textContent = 'Standard: A-K white keys, W-U black keys (C4-C5)';
            }
        }

        // Build keyboard UI
        function buildKeyboard() {
            const keyboard = document.getElementById('keyboard');
            const notes = ['C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4', 'C5'];
            const whiteNotes = notes.filter(n => !n.includes('#'));
            const blackNotes = notes.filter(n => n.includes('#'));

            // White keys
            whiteNotes.forEach((note, i) => {
                const key = document.createElement('div');
                key.className = 'key white';
                key.dataset.note = note;

                const label = Object.entries(keyMap).find(([k, n]) => n === note);
                if (label) {
                    const labelEl = document.createElement('span');
                    labelEl.className = 'key-label';
                    labelEl.textContent = label[0].toUpperCase();
                    key.appendChild(labelEl);
                }

                keyboard.appendChild(key);
            });

            // Black keys - position them absolutely
            const blackKeyPositions = [0, 1, 3, 4, 5, 7, 8]; // Positions relative to white keys
            blackNotes.forEach((note, i) => {
                const key = document.createElement('div');
                key.className = 'key black';
                key.dataset.note = note;
                key.style.left = `${blackKeyPositions[i] * 52 + 36}px`;

                const label = Object.entries(keyMap).find(([k, n]) => n === note);
                if (label) {
                    const labelEl = document.createElement('span');
                    labelEl.className = 'key-label';
                    labelEl.textContent = label[0].toUpperCase();
                    key.appendChild(labelEl);
                }

                keyboard.appendChild(key);
            });

            // Mouse events
            keyboard.addEventListener('mousedown', (e) => {
                const key = e.target.closest('.key');
                if (key) playNote(key.dataset.note);
            });

            keyboard.addEventListener('mouseup', (e) => {
                const key = e.target.closest('.key');
                if (key) stopNote(key.dataset.note);
            });

            keyboard.addEventListener('mouseleave', () => {
                activeVoices.forEach((_, note) => stopNote(note));
            });
        }

        // Build sequencer
        const sequencerNotes = ['C5', 'B4', 'A#4', 'A4', 'G#4', 'G4', 'F#4', 'F4', 'E4', 'D#4', 'D4', 'C#4', 'C4'];
        const sequencerSteps = 16;
        const sequence = Array(sequencerNotes.length).fill(null).map(() => Array(sequencerSteps).fill(false));
        let sequencerPlaying = false;
        let currentStep = 0;
        let sequencerInterval = null;

        function buildSequencer() {
            const grid = document.getElementById('sequencerGrid');

            sequencerNotes.forEach((note, noteIndex) => {
                // Note label
                const label = document.createElement('div');
                label.className = 'seq-note-label';
                label.textContent = note;
                grid.appendChild(label);

                // Steps
                for (let step = 0; step < sequencerSteps; step++) {
                    const stepEl = document.createElement('div');
                    stepEl.className = 'seq-step';
                    stepEl.dataset.note = noteIndex;
                    stepEl.dataset.step = step;

                    stepEl.addEventListener('click', () => {
                        sequence[noteIndex][step] = !sequence[noteIndex][step];
                        stepEl.classList.toggle('active', sequence[noteIndex][step]);
                    });

                    grid.appendChild(stepEl);
                }
            });
        }

        function playSequencer() {
            sequencerPlaying = true;
            document.getElementById('seqPlayBtn').textContent = 'Stop';
            document.getElementById('seqPlayBtn').classList.add('playing');

            const tempo = parseInt(document.getElementById('tempo').value) || 120;
            const stepTime = (60 / tempo) / 4 * 1000; // 16th notes

            sequencerInterval = setInterval(() => {
                // Clear previous step highlight
                document.querySelectorAll('.seq-step.current').forEach(el => el.classList.remove('current'));

                // Highlight current step
                document.querySelectorAll(`.seq-step[data-step="${currentStep}"]`).forEach(el => el.classList.add('current'));

                // Play notes
                sequencerNotes.forEach((note, noteIndex) => {
                    if (sequence[noteIndex][currentStep]) {
                        playNote(note);
                        setTimeout(() => stopNote(note), stepTime * 0.8);
                    }
                });

                currentStep = (currentStep + 1) % sequencerSteps;
            }, stepTime);
        }

        function stopSequencer() {
            sequencerPlaying = false;
            document.getElementById('seqPlayBtn').textContent = 'Play';
            document.getElementById('seqPlayBtn').classList.remove('playing');
            clearInterval(sequencerInterval);
            document.querySelectorAll('.seq-step.current').forEach(el => el.classList.remove('current'));
            currentStep = 0;
        }

        // Visualizer
        function drawVisualizer() {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');

            function resize() {
                canvas.width = canvas.offsetWidth * window.devicePixelRatio;
                canvas.height = canvas.offsetHeight * window.devicePixelRatio;
                ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            }
            resize();
            window.addEventListener('resize', resize);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                requestAnimationFrame(draw);

                analyser.getByteTimeDomainData(dataArray);

                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);

                ctx.lineWidth = 2;
                ctx.strokeStyle = '#7289da';
                ctx.beginPath();

                const sliceWidth = canvas.offsetWidth / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * canvas.offsetHeight / 2;

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);

                    x += sliceWidth;
                }

                ctx.lineTo(canvas.offsetWidth, canvas.offsetHeight / 2);
                ctx.stroke();
            }
            draw();
        }

        // ADSR visualization
        function drawADSR() {
            const canvas = document.getElementById('adsrCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            const w = canvas.offsetWidth;
            const h = canvas.offsetHeight;
            const padding = 10;

            ctx.clearRect(0, 0, w, h);

            // Normalize times
            const totalTime = state.attack + state.decay + 0.5 + state.release;
            const attackX = padding + (state.attack / totalTime) * (w - padding * 2);
            const decayX = attackX + (state.decay / totalTime) * (w - padding * 2);
            const sustainX = decayX + (0.5 / totalTime) * (w - padding * 2);
            const releaseX = w - padding;

            ctx.strokeStyle = '#7289da';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, h - padding);
            ctx.lineTo(attackX, padding); // Attack
            ctx.lineTo(decayX, padding + (1 - state.sustain) * (h - padding * 2)); // Decay
            ctx.lineTo(sustainX, padding + (1 - state.sustain) * (h - padding * 2)); // Sustain
            ctx.lineTo(releaseX, h - padding); // Release
            ctx.stroke();

            // Fill
            ctx.fillStyle = 'rgba(114, 137, 218, 0.2)';
            ctx.beginPath();
            ctx.moveTo(padding, h - padding);
            ctx.lineTo(attackX, padding);
            ctx.lineTo(decayX, padding + (1 - state.sustain) * (h - padding * 2));
            ctx.lineTo(sustainX, padding + (1 - state.sustain) * (h - padding * 2));
            ctx.lineTo(releaseX, h - padding);
            ctx.closePath();
            ctx.fill();
        }

        // Knob interaction
        function setupKnobs() {
            const knobs = document.querySelectorAll('.knob');
            let activeKnob = null;
            let startY = 0;
            let startValue = 0;

            knobs.forEach(knob => {
                const param = knob.dataset.param;
                const min = parseFloat(knob.dataset.min);
                const max = parseFloat(knob.dataset.max);
                const isLog = knob.dataset.log === 'true';
                let value = parseFloat(knob.dataset.value);

                function updateKnob(newValue) {
                    value = Math.max(min, Math.min(max, newValue));
                    state[param] = value;

                    // Update display
                    const valueEl = document.getElementById(param + 'Val');
                    if (valueEl) {
                        if (param.includes('Octave')) {
                            valueEl.textContent = Math.round(value);
                        } else if (param.includes('Detune')) {
                            valueEl.textContent = Math.round(value);
                        } else if (value >= 1000) {
                            valueEl.textContent = Math.round(value);
                        } else {
                            valueEl.textContent = value.toFixed(2);
                        }
                    }

                    // Update knob rotation
                    const normalized = isLog
                        ? (Math.log(value) - Math.log(min)) / (Math.log(max) - Math.log(min))
                        : (value - min) / (max - min);
                    const rotation = -135 + normalized * 270;
                    knob.style.setProperty('--rotation', rotation + 'deg');
                    knob.querySelector('::after')?.style;
                    knob.style.transform = `rotate(${rotation}deg)`;

                    // Apply to audio
                    applyParam(param, value);

                    // Update ADSR visual
                    if (['attack', 'decay', 'sustain', 'release'].includes(param)) {
                        drawADSR();
                    }
                }

                updateKnob(value); // Initialize

                knob.addEventListener('mousedown', (e) => {
                    activeKnob = knob;
                    startY = e.clientY;
                    startValue = value;
                    e.preventDefault();
                });

                knob.addEventListener('dblclick', () => {
                    updateKnob(parseFloat(knob.dataset.value));
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!activeKnob) return;

                const param = activeKnob.dataset.param;
                const min = parseFloat(activeKnob.dataset.min);
                const max = parseFloat(activeKnob.dataset.max);
                const isLog = activeKnob.dataset.log === 'true';

                const deltaY = startY - e.clientY;
                const sensitivity = (max - min) / 200;

                let newValue;
                if (isLog) {
                    const logMin = Math.log(min);
                    const logMax = Math.log(max);
                    const logStart = Math.log(startValue);
                    const logDelta = (logMax - logMin) / 200 * deltaY;
                    newValue = Math.exp(logStart + logDelta);
                } else {
                    newValue = startValue + deltaY * sensitivity;
                }

                const knobs = document.querySelectorAll('.knob');
                const knob = Array.from(knobs).find(k => k.dataset.param === param);
                if (knob) {
                    knob.dispatchEvent(new CustomEvent('updateValue', { detail: newValue }));
                }

                // Directly update
                state[param] = Math.max(min, Math.min(max, newValue));
                const valueEl = document.getElementById(param + 'Val');
                const value = state[param];
                if (valueEl) {
                    if (param.includes('Octave')) {
                        valueEl.textContent = Math.round(value);
                    } else if (param.includes('Detune')) {
                        valueEl.textContent = Math.round(value);
                    } else if (value >= 1000) {
                        valueEl.textContent = Math.round(value);
                    } else {
                        valueEl.textContent = value.toFixed(2);
                    }
                }

                const normalized = isLog
                    ? (Math.log(value) - Math.log(min)) / (Math.log(max) - Math.log(min))
                    : (value - min) / (max - min);
                const rotation = -135 + normalized * 270;
                activeKnob.style.transform = `rotate(${rotation}deg)`;

                applyParam(param, value);

                if (['attack', 'decay', 'sustain', 'release'].includes(param)) {
                    drawADSR();
                }
            });

            document.addEventListener('mouseup', () => {
                activeKnob = null;
            });
        }

        function applyParam(param, value) {
            if (!audioCtx) return;

            switch (param) {
                case 'filterCutoff':
                    filter.frequency.value = value;
                    break;
                case 'filterRes':
                    filter.Q.value = value;
                    break;
                case 'delayTime':
                    delayNode.delayTime.value = value;
                    break;
                case 'delayFeedback':
                    delayFeedback.gain.value = value;
                    break;
                case 'delayMix':
                    if (state.delayEnabled) delayMix.gain.value = value;
                    break;
                case 'masterGain':
                    masterGain.gain.value = value;
                    break;
            }
        }

        // Waveform selection
        function setupWaveformSelectors() {
            ['osc1Wave', 'osc2Wave'].forEach(oscId => {
                const container = document.getElementById(oscId);
                container.querySelectorAll('.wave-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        container.querySelectorAll('.wave-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        state[oscId] = btn.dataset.wave;
                    });
                });
            });
        }

        // Presets
        const presets = {
            init: {
                osc1Wave: 'sine', osc2Wave: 'square',
                osc1Gain: 0.5, osc2Gain: 0.3, osc1Detune: 0, osc2Detune: 5, osc2Octave: 0,
                filterCutoff: 5000, filterRes: 1, filterEnv: 2000,
                attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.3,
                delayEnabled: false
            },
            bass: {
                osc1Wave: 'sawtooth', osc2Wave: 'square',
                osc1Gain: 0.6, osc2Gain: 0.4, osc1Detune: 0, osc2Detune: -5, osc2Octave: -1,
                filterCutoff: 800, filterRes: 4, filterEnv: 500,
                attack: 0.01, decay: 0.1, sustain: 0.8, release: 0.1,
                delayEnabled: false
            },
            lead: {
                osc1Wave: 'sawtooth', osc2Wave: 'sawtooth',
                osc1Gain: 0.5, osc2Gain: 0.5, osc1Detune: -10, osc2Detune: 10, osc2Octave: 0,
                filterCutoff: 3000, filterRes: 2, filterEnv: 3000,
                attack: 0.01, decay: 0.3, sustain: 0.6, release: 0.2,
                delayEnabled: true
            },
            pad: {
                osc1Wave: 'sine', osc2Wave: 'triangle',
                osc1Gain: 0.4, osc2Gain: 0.4, osc1Detune: -5, osc2Detune: 5, osc2Octave: 1,
                filterCutoff: 2000, filterRes: 1, filterEnv: 1000,
                attack: 0.5, decay: 0.5, sustain: 0.7, release: 1.0,
                delayEnabled: true
            },
            pluck: {
                osc1Wave: 'triangle', osc2Wave: 'square',
                osc1Gain: 0.6, osc2Gain: 0.3, osc1Detune: 0, osc2Detune: 0, osc2Octave: 1,
                filterCutoff: 5000, filterRes: 3, filterEnv: 4000,
                attack: 0.001, decay: 0.3, sustain: 0.0, release: 0.2,
                delayEnabled: true
            },
            brass: {
                osc1Wave: 'sawtooth', osc2Wave: 'sawtooth',
                osc1Gain: 0.5, osc2Gain: 0.4, osc1Detune: 0, osc2Detune: 3, osc2Octave: 0,
                filterCutoff: 1000, filterRes: 2, filterEnv: 3000,
                attack: 0.1, decay: 0.2, sustain: 0.8, release: 0.15,
                delayEnabled: false
            }
        };

        function applyPreset(name) {
            const preset = presets[name];
            if (!preset) return;

            Object.assign(state, preset);

            // Update UI
            document.querySelectorAll('.knob').forEach(knob => {
                const param = knob.dataset.param;
                if (state[param] !== undefined) {
                    const min = parseFloat(knob.dataset.min);
                    const max = parseFloat(knob.dataset.max);
                    const isLog = knob.dataset.log === 'true';
                    const value = state[param];

                    const normalized = isLog
                        ? (Math.log(value) - Math.log(min)) / (Math.log(max) - Math.log(min))
                        : (value - min) / (max - min);
                    const rotation = -135 + normalized * 270;
                    knob.style.transform = `rotate(${rotation}deg)`;

                    const valueEl = document.getElementById(param + 'Val');
                    if (valueEl) {
                        if (param.includes('Octave')) {
                            valueEl.textContent = Math.round(value);
                        } else if (param.includes('Detune')) {
                            valueEl.textContent = Math.round(value);
                        } else if (value >= 1000) {
                            valueEl.textContent = Math.round(value);
                        } else {
                            valueEl.textContent = value.toFixed(2);
                        }
                    }

                    applyParam(param, value);
                }
            });

            // Update waveform buttons
            ['osc1Wave', 'osc2Wave'].forEach(oscId => {
                const container = document.getElementById(oscId);
                container.querySelectorAll('.wave-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.wave === state[oscId]);
                });
            });

            // Update delay toggle
            document.getElementById('delayToggle').classList.toggle('active', state.delayEnabled);
            if (delayMix) delayMix.gain.value = state.delayEnabled ? state.delayMix : 0;

            drawADSR();

            // Update preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.preset === name);
            });
        }

        // Setup preset buttons
        function setupPresets() {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => applyPreset(btn.dataset.preset));
            });
        }

        // Delay toggle
        function setupDelayToggle() {
            const toggle = document.getElementById('delayToggle');
            toggle.addEventListener('click', () => {
                state.delayEnabled = !state.delayEnabled;
                toggle.classList.toggle('active', state.delayEnabled);
                if (delayMix) delayMix.gain.value = state.delayEnabled ? state.delayMix : 0;
            });
        }

        // Keyboard input
        const pressedKeys = new Set();

        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const note = keyMap[e.key.toLowerCase()];
            if (note && !pressedKeys.has(e.key.toLowerCase())) {
                pressedKeys.add(e.key.toLowerCase());
                playNote(note);
            }
        });

        document.addEventListener('keyup', (e) => {
            const note = keyMap[e.key.toLowerCase()];
            if (note) {
                pressedKeys.delete(e.key.toLowerCase());
                stopNote(note);
            }
        });

        // Sequencer controls
        document.getElementById('seqPlayBtn').addEventListener('click', () => {
            if (sequencerPlaying) stopSequencer();
            else playSequencer();
        });

        document.getElementById('seqClearBtn').addEventListener('click', () => {
            sequence.forEach(row => row.fill(false));
            document.querySelectorAll('.seq-step').forEach(el => el.classList.remove('active'));
        });

        document.getElementById('tempo').addEventListener('change', () => {
            if (sequencerPlaying) {
                stopSequencer();
                playSequencer();
            }
        });

        // Start prompt
        document.getElementById('startPrompt').addEventListener('click', () => {
            initAudio();
            document.getElementById('startPrompt').classList.add('hidden');
            drawADSR();
        });

        // Initialize UI
        buildKeyboard();
        buildSequencer();
        setupKnobs();
        setupWaveformSelectors();
        setupPresets();
        setupDelayToggle();
    </script>
</body>
</html>
